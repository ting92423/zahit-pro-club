# Zählt × 平交道咖啡｜測試案例與驗收清單（首日上線）

> 版本：v1.0｜日期：2025-12-31  
> 對應文件：`docs/pro-club-prd.md`、`docs/pro-club-flows-and-state-machines.md`、`docs/pro-club-api-spec.md`

---

### 0) 測試分層（建議）

- **UAT（營運驗收）**：照本文件逐項勾選
- **回歸測試**：每次發版至少跑「首日必測主路徑」
- **異常測試**：金流重送、核銷重刷、退款回沖、候補轉正等

---

### 1) 首日必測主路徑（MVO）

#### 1.1 訪客 → 內容/型錄 → 加入會員

- [ ] 訪客可開啟官網內容頁、活動列表、型錄列表
- [ ] Link Hub 外連（FB/IG/YT/加入 LINE）可正常開啟
- [ ] 型錄可在 LINE 內開啟（內建瀏覽器）且可分享連結

#### 1.2 會員登入（LINE + Email）與資料必填

- [ ] LINE 登入成功：首次登入會建立會員並導向補資料
- [ ] Email 登入（OTP）成功：OTP 過期/錯誤會被拒絕
- [ ] 會員必填欄位驗證：姓名/手機/Email 缺一不可
- [ ] Email 驗證：未驗證的 Email 不可完成「綁定/合併」

#### 1.3 用戶自助綁定（LINE ↔ Email）

- [ ] 已用 LINE 登入的會員可發起 Email 綁定並完成驗證
- [ ] 已用 Email 登入的會員可綁定 LINE（若提供此 UI）
- [ ] 綁定成功後，同一人用 LINE 與 Email 登入都回到同一 `member_id`
- [ ] 綁定行為有 audit log 可查（含時間與操作者）
- [ ] 衝突情境：Email 已綁另一會員時，系統要求二次驗證並提示合併風險

---

### 2) 點數（可稽核）

#### 2.1 發點/扣點流水

- [ ] 管理員人工調整點數後：
  - [ ] 會員餘額正確
  - [ ] 流水可查（含 reason / created_by）
  - [ ] 可匯出（CSV/Excel）

#### 2.2 點數折抵（電商）

- [ ] 結帳使用點數折抵：折抵金額計算正確（受上限參數影響）
- [ ] 點數不足時不可折抵
- [ ] 訂單取消/付款失敗時：點數會自動回補（以反向流水或等效機制）
- [ ] 同一筆金流 callback 重送：點數不會重複扣/加（冪等）

#### 2.3 兌換（券/商品）與核銷

- [ ] 會員兌換成功後會得到可核銷 QR token（且有有效期）
- [ ] Staff 掃碼核銷成功：狀態變更為已核銷，紀錄核銷人/時間
- [ ] 重複掃同一 token：不會重複核銷/不會重複扣點（冪等）
- [ ] 過期 token：提示過期不可用

---

### 3) 等級（自動升級）

- [ ] 當交易/發點達門檻時，自動升級至對應等級
- [ ] 會員中心可看到等級與進度
- [ ] 需要核銷的權益：可用 QR 核銷，也可後台手動標記

---

### 4) 活動（報名/候補/提醒/報到）

#### 4.1 活動建立與報名

- [ ] 管理員可建立活動（含名額、免費/付費、是否候補）
- [ ] 會員可報名活動且名額扣減正確

#### 4.2 候補（可調整）

- [ ] 名額滿時進入候補名單（WAITLIST）
- [ ] 名額釋出轉正時：
  - [ ] 會員收到通知（LINE 或 Email，依設定）
  - [ ] 狀態正確變更

#### 4.3 付費活動（若啟用）

- [ ] 付款成功才算報名成功（預設）
- [ ] 付款失敗/取消：報名不成立或回到 UNPAID（依規則）

#### 4.4 現場報到（Staff 掃碼）

- [ ] Staff 掃會員 QR 或報名 QR 成功報到（CHECKED_IN）
- [ ] 重複掃碼：回同結果，不重複寫入（冪等）
- [ ] 後台可看報到名單與出席率

---

### 5) 電商（首日：下單→綠界付款→出貨→完成）

#### 5.1 商品/庫存

- [ ] 商品列表顯示正確（一般價/會員價）
- [ ] 庫存不足不可下單，或下單後庫存扣減策略符合設計（需明確）

#### 5.2 下單

- [ ] 建立訂單成功：狀態為 UNPAID（或 CREATED→UNPAID）
- [ ] 同一 `Idempotency-Key` 重送建立訂單：不會產生重複訂單
- [ ] **訪客下單（不登入）**
  - [ ] 訪客可直接建立訂單（必填：姓名/手機/Email/地址）
  - [ ] 回傳 `order_number` 可供後續查詢
  - [ ] 訪客可用 `order_number + email` 查詢訂單狀態（不需登入）[[memory:12722575]]

#### 5.3 付款（綠界）

- [ ] 付款成功 callback：
  - [ ] Payment=SUCCEEDED
  - [ ] Order=PAID
  - [ ]（若有）發點/分潤 PENDING 正確產生
- [ ] callback 重送：不會重複改狀態/重複寫流水（冪等）
- [ ] callback 簽章驗證失敗：拒絕處理並記錄告警

#### 5.4 出貨與完成（服務完成）

- [ ] 管理員可將訂單推進到 SHIPPED（含承運商/單號*若人工輸入*）
- [ ] 管理員可將訂單推進到 COMPLETED（視為服務完成）

#### 5.5 取消/退款

- [ ] 訂單取消：狀態正確；庫存/點數/分潤處理正確
- [ ] 退款：
  - [ ] Order=REFUNDED（或等效）
  - [ ] 點數回補（若曾折抵）
  - [ ] 分潤自動回沖（若已產生）

---

### 6) 分潤（Sales QR last-touch，7 天；服務完成成立；退款回沖）

#### 6.1 歸因（last-touch）

- [ ] 客人經由 Sales QR/連結進入：成功寫入 attribution token
- [ ] 7 天內成交：訂單/付款關聯到該 sales（last-touch）
- [ ] 同客人 7 天內掃不同 sales：以最後一次為準

#### 6.2 分潤成立點（服務完成）

- [ ] 訂單 PAID 時：分潤為 PENDING（尚未成立）
- [ ] 訂單 COMPLETED/服務完成事件：分潤轉為 ELIGIBLE（成立）

#### 6.3 回沖

- [ ] 退款/取消後：分潤自動回沖為 REVERSED（或產生反向流水）
- [ ] 報表同步反映回沖

---

### 7) 後台權限與資料可見性（安全）

- [ ] Staff 只能看到核銷/報到需要的最少資訊（不可瀏覽全量會員資料）
- [ ] Sales 只能看到自己的分潤與歸因（不可看其他 sales）
- [ ] Admin 可稽核所有流水（點數/分潤/核銷/付款）

---

### 8) 報表與匯出

- [ ] 會員新增/活躍/等級分布正確
- [ ] 點數發放/使用/餘額分布正確
- [ ] 活動報名/出席/核銷統計正確
- [ ] 電商營收/訂單/客單正確
- [ ] 分潤成交/可結算/已結算/回沖正確
- [ ] 匯出檔案內容與欄位一致且可被會計/營運使用

