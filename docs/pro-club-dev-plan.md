# Zählt × 平交道咖啡｜Pro友俱樂部 系統需求全景（開發企劃與順序）

> 文件目的：把「官網內容 / 會員分級 / 點數制度 / 活動報名與 QR 核銷 / 廣告位刊登 / 電子型錄 /（可含）電商購物 / CRM 分眾推播與報表 / 業務分潤歸因 QR」整合成**一次上線即可營運**的完整系統落地計畫。  
> 文件狀態：可作為啟動會議對齊、排期、切 Sprint、驗收依據。  
> 版本：v0.1（草案）｜日期：2025-12-31

---

### 1) 目標（對齊用）

- **主目標**：打造一套「Pro友俱樂部」，讓客人端的接觸 → 加入 → 消費 → 累點 → 活動/兌換核銷 → 推播再行銷 → 報表回收，形成可營運閉環；並支援廣告位與分潤歸因（業務 QR）作為營收/推廣引擎。
- **一次上線可用**：首日上線後即具備「會員可用、現場可掃、後台可管、報表可看、交易可稽核」的最低營運能力。

---

### 2) 角色與權限（RBAC）— 先定義，後續才能穩定擴充

- **訪客（Anonymous）**
  - 看官網內容/型錄/活動資訊
  - 進入 Link Hub（官網/社群/LINE/活動/型錄）
  -（可選）直接購買（若電商在本次範圍）
- **會員（Member）**
  - LINE/Email 登入（以 LINE 為主）
  - 會員中心：會員卡 QR、等級/權益、點數/明細、活動報名/報到狀態、（可選）訂單
- **店員/活動人員（Staff）**
  - 掃碼：活動報到/兌換/權益核銷
  - 查詢：會員資料/點數/報名（限必要資訊）
  -（可選）補登資料/交易（視營運流程）
- **管理員（Admin）**
  - 內容/型錄/活動/會員/等級/點數/廣告位/推播/報表全權
  - 稽核：點數流水、核銷紀錄、（可選）訂單與退款
- **業務/推廣者（Affiliate / Sales）**
  - 個人專屬 QR/連結（加入/付款/購買入口）
  - 成交歸因與分潤報表（僅看自己的）

> 權限原則：**可見最小化**（Staff 只看現場需要；Sales 只看自身；Admin 可稽核全域）。

---

### 3) 模組清單（一次上線的「必備」與「可選」開關）

#### 3.1 前台（客人看得到）

- **M1｜品牌官網內容（CMS）**（必備）
  - 品牌故事/理念、服務項目/流程/價格、案例、場地特色、活動資訊與花絮
  - Link Hub（官網/FB/IG/YT/加入 LINE/活動/型錄）
- **M2｜電子型錄 / 檔案中心**（必備）
  - 多頁瀏覽、下載、分享連結、一鍵轉傳
  - 可置入外部連結；可在 LINE 內開啟
- **M3｜會員中心（Pro友俱樂部）**（必備）
  - 註冊/登入（LINE 為主 + Email）
  - 數位會員卡（含會員 QR）
  - 會員分級與權益呈現、升級條件/進度
  - 點數：累積、折抵/兌換、明細查詢
  - 活動：報名、提醒、報到核銷
  -（可選）廣告位申請入口 + 進度
  -（可選）訂單查詢
- **M4｜分潤歸因 QR（業務專屬入口頁）**（必備）
  - 每位業務/推廣者的專屬 QR/連結
  - 導向：加入會員 / 付款 / 購買（依本次範圍）
  - 歸因：本次成交、（可選）會員長期綁定
- **M5｜電商購物**（本次範圍：首日包含）
  - 商品展示、購物車、結帳付款
  - 會員價/優惠、點數折抵（與 M3 點數整合）
  - 訂單狀態（未付款/已付款/出貨/完成）
  - 電子發票/物流串接（本次：盡快啟用；首日可先預留介面）

#### 3.2 後台（營運管理）

- **B1｜CRM 會員管理後台**（必備）
  - 會員資料、等級、點數、消費與活動紀錄
  - 會員標籤/分群（分眾推播用）
  - 行為紀錄追蹤（依需求深度）
- **B2｜通知/分眾推播（LINE 為主）**（必備）
  - 分類推播：依等級/標籤/條件分群
  - 推播紀錄與成效（至少：送達/開啟/點擊*若可得*）
- **B3｜點數後台**（必備）
  - 點數規則設定、人工調整、稽核流水
  - 兌換品項/兌換紀錄
  - 點數交易紀錄查詢/匯出
- **B4｜活動後台**（必備）
  - 活動建立、名額、報名名單
  - 報到/核銷紀錄、出席率統計
- **B5｜廣告位後台**（可選：若首日要營收化）  
  - 方案/價格/折扣（含會員等級優惠）
  - 素材提交審核、檔期排程、刊登紀錄與報表
- **B6｜電商後台**（本次範圍：首日包含）  
  - 商品/SKU/庫存/價格/會員價、訂單/出貨/付款狀態
  - 發票/物流串接管理（本次：盡快啟用；首日可先不上線）
- **B7｜分潤後台**（必備）
  - 業務名單管理、專屬 QR 產生
  - 歸因規則（有效時間、最後一次歸因）
  - 分潤流水與結算報表（可匯出）
- **B8｜統計報表**（必備：先做「營運必需」指標）
  - 會員（新增/活躍/等級分布）
  - 點數（發點/用點/餘額分布）
  - 活動（報名/出席/核銷）
  - 分潤（成交/可結算/已結算）
  -（可選）廣告位與電商報表

---

### 4) 7 條主旅程 → 功能對照（用來驗證「不是孤島」）

- **旅程 1｜首次接觸 → 加入 LINE/會員**
  - M1/M2 Link Hub → 加入 LINE → M3 註冊/登入 → 產生會員資料 + 會員卡 QR
- **旅程 2｜消費 → 自動累點 → 等級更新**
  - 點數規則（B3）→ 交易入帳 → 點數流水 → 等級進度更新（M3）
- **旅程 3｜點數使用（折抵/兌換）**
  - 兌換品項 → 扣點流水 → 核銷（Staff 掃碼）→ 稽核（B3）
- **旅程 4｜活動報名 → 提醒 → 現場報到核銷**
  - M3 報名 → B4 名單 → 推播提醒（B2）→ Staff 掃碼核銷 → 統計報表（B8）
- **旅程 5｜廣告位申請 → 付款/審核 → 排程上架**（可選）
  - M3 申請入口 → B5 審核/排程 →（可選）付款 → 刊登與報表
- **旅程 6｜型錄分享 → 導流加入/報名/購買**
  - M2 分享連結 → 來源追蹤（UTM/QR）→ 轉換（加入/報名/購買）
- **旅程 7｜業務分潤歸因（A+B）→ 成交 + 長期綁定**
  - M4 專屬入口 → 歸因 Cookie/Token → 成交歸因（A）+ 會員綁定（B 可選）→ B7 結算

---

### 5) 產品決策（已定案 / 可調整參數）

#### 5.1 入口與登入
- **登入主方案（已定案）**：**LINE 登入 + Email 登入（LINE 為主）**
- **會員必填欄位（已定案｜先用常規欄位）**
  - **必填**：姓名、手機、Email
  - **可選**：生日、車種/車牌、地址（若首日需寄送則再提升為必填）、其他自訂欄位
- **帳號合併/綁定規則（已定案）**：允許合併；由**用戶自行綁定**（LINE ↔ Email）
  - 建議流程：Email 驗證碼/驗證信 + 登入狀態下綁定；綁定/解綁全程留 audit log 供後台稽核

#### 5.2 會員等級（Bronze/Silver/Gold）
- **升級方式（已定案）**：**自動升級**
- **需核銷的權益與核銷方式（已定案）**：**兩者皆可（QR 核銷 + 後台手動標記）**

#### 5.3 點數制度
- **折抵範圍（方向）**：飲品 / 活動費用 / 服務費/施工費 / 廣告位 / 電商商品（以上皆可能）
- **折抵上限（已定案）**：做成**可調整參數**（支援：每筆最多折抵 % 與/或固定金額上限）
- **兌換型態（已定案）**：**兩者都有（抵用金券 + 商品）**
- **點數有效期與延長（已定案）**：延長條件中的「消費」類型做成**可調整參數**，可選：
  - 飲品/現場消費、活動付費、廣告位購買、電商購買

#### 5.4 活動
- **付費報名（可調整）**：活動可設定「免費/付費」；若付費，預設 **付款成功才算報名成功**（可改）
- **候補（可調整）**：可設定「是否候補」；候補轉正通知渠道可選 **LINE 推播 / Email**

#### 5.5 廣告位（若在首日範圍）
- **流程偏好（已定案）**：**先審核通過再付款**
- **同檔期同版位（已定案）**：允許多家**輪播**，但**需要限制名額**
  - 建議參數：每檔期每版位最大上架家數（可設定）

#### 5.6 電商（本次範圍：首日包含）
- **首日範圍（已定案）**：**完整下單出貨**
- **金流（已定案）**：**綠界**
- **電子發票與物流（現況/目標）**：
  - 現況：**尚未準備好**
  - 目標：**希望盡快啟用**
  - 開發策略：首日先完成「下單/付款/出貨狀態機 + 對帳」；同時預留發票/物流擴充點，待申請就緒後快速補上線

#### 5.7 分潤歸因（業務 QR）
- **分潤成立時點（已定案）**：**服務完成才成立**
- **歸因有效時間（已定案）**：**7 天**
- **多次掃碼歸因（已定案）**：**最後一次為主**
- **退款/取消回沖（已定案）**：**需要（自動回沖分潤與報表）**
- **分潤計算（已定案）**：**依不同品項不同規則**
- **會員綁定業務更換（已定案）**：**允許**（建議冷卻期：30 天；做成可調整參數）

---

### 6) 技術與架構建議（可營運、可稽核、可擴充）

> 此段先給「應該長什麼樣」的原則；實作技術棧可再依團隊熟悉度決定。

- **UX 原則（硬性要求：避免淪為工程師看的網站）**
  - 任何功能設計/實作都必須先回答「使用者要完成的任務」與「最短路徑」：少步驟、少認知負擔、少填寫。
  - 會員中心與 Staff 掃碼流程以**手機**為第一優先；所有關鍵操作需可在 30 秒內完成（含清楚提示與回饋）。
  - 後台表單/列表需支援搜尋/篩選/匯出，並提供「下一步」引導（避免只堆功能）。
  - 每個里程碑驗收時，必須同時驗收 UX（loading/錯誤訊息/成功回饋/防呆/一致性），不僅驗收功能可用。

- **核心原則**
  - **所有金流/點數/核銷**都必須產生不可變更的「流水紀錄」（append-only / audit log）
  - 任何會員狀態（等級、點數餘額、報名狀態）都可由流水/事件重建（至少能追溯）
  - QR 流程必須有**一次性 token / 有效期 / 防重放**（避免截圖重複核銷）
- **建議的系統分層**
  - 前台（官網+會員中心+型錄）  
  - 後台（CRM/活動/點數/推播/分潤/報表）  
  - API（Auth、會員、點數、活動、核銷、推播、分潤、（可選）電商）
- **登入整合（以 LINE 為主 + Email）**
  - LINE Login（OIDC）取得 userId；會員資料綁定後才有完整檔案
  - 推播需 LINE Official Account + Messaging API（及必要的同意流程）

---

### 7) 資料模型草案（先定義「可稽核」核心表）

> 目標：後續無論電商/廣告位/線下消費，都能共用「會員、交易、點數、核銷、歸因」骨架。

- **Member**
  - id、line_user_id（可選）、手機/Email（可選）、姓名、生日、建立時間、狀態
- **MemberTier**
  - tier_code（Bronze/Silver/Gold）、門檻規則、權益內容、有效期
- **MemberTierStatus**
  - member_id、current_tier、progress、last_evaluated_at、（可選）needs_admin_confirm
- **PointLedger（點數流水｜append-only）**
  - id、member_id、type（EARN/REDEEM/ADJUST/EXPIRE）、points_delta、reason_code、ref_type/ref_id、created_by、created_at
- **PointBalance（可由 ledger 聚合，也可快取）**
  - member_id、balance、updated_at
- **Event**
  - id、標題、時間、地點、名額、費用、報名條件（等級/標籤）、狀態
- **EventRegistration**
  - id、event_id、member_id、status（REGISTERED/PAID/CHECKED_IN/CANCELLED/WAITLIST）、qr_token、qr_expires_at
- **RedemptionItem / Voucher（兌換品/券）**
  - item_id、名稱、所需點數、庫存/有效期、核銷規則
- **Redemption**
  - id、member_id、item_id、status（ISSUED/REDEEMED/VOID）、qr_token、核銷時間/人員
- **StaffUser / AdminUser / SalesUser**
  - 角色與權限，對應後台帳號體系
- **AffiliateLink / AffiliateAttribution**
  - sales_id、code、landing_url、attribution_token、first_touch/last_touch、expires_at
- **PayoutLedger（分潤流水｜append-only）**
  - id、sales_id、ref_type/ref_id（訂單/付款/活動/廣告位）、amount、status（PENDING/ELIGIBLE/PAID/REVERSED）
- **Content / CatalogFile**
  - CMS 內容與型錄檔案、分享連結、外部連結
-（可選）**Order / Payment / Shipment / Invoice**
  - 若電商納入首日範圍

---

### 8) 開發順序（里程碑 / Sprint 拆解）—「一次上線可用」建議路線

> 原則：先做「身份 → 核心流水（點數/核銷/歸因）→ 後台可管 → 推播 → 報表」。  
> 但本案已定案「首日包含電商完整下單出貨」，因此電商主線會提早納入上線關鍵路徑（發票/物流可在申請完成後快速補上線）。

#### Milestone 0｜專案啟動與決策凍結（0.5～1 週）
- **輸出物**
  - 本文件 v1.0（決策已填完）
  - 資料字典（欄位/枚舉/狀態機）
  - QR/核銷/點數/分潤規則（清楚到可寫測試）
- **驗收**
  - 5.1～5.7 決策全數拍板（未拍板者標記為「首日不做」）

#### Milestone 1｜基礎平台：登入 + 會員中心骨架 + RBAC（1～2 週）
- **範圍**
  - LINE Login + Email 登入（含帳號綁定/合併規則）
  - 會員中心：會員卡 QR、基本資料頁
  - 後台帳號（Admin/Staff/Sales）與權限
- **驗收**
  - 會員可登入看到自己的會員卡 QR
  - Staff/ Admin 可登入後台且權限正確

#### Milestone 2｜點數與等級（可稽核）+ 基礎報表（2～3 週）
- **範圍**
  - 點數規則設定（發點/扣點/有效期）
  - 折抵範圍/折抵上限/延長條件：做成可調整參數（規則引擎）
  - 點數流水（不可變更）+ 餘額查詢
  - 會員等級進度計算（自動升級）
  - 基礎報表：會員新增/活躍、發點/用點
- **驗收**
  - 任一筆加/扣點都有流水可追溯（含建立者與原因）
  - 會員中心可查點數明細；後台可匯出

#### Milestone 3｜活動：報名 → 推播提醒 → 現場掃碼報到/核銷（2～3 週）
- **範圍**
  - 活動建立、名額、報名名單
  -（可調整）活動可設定付費/免費；若付費，預設付款成功才算報名成功
  -（可調整）候補機制 + 轉正通知（LINE 推播 / Email）
  - QR 報到核銷：一次性 token、防重複核銷
  - 推播：報名成功/行前提醒/狀態變更
- **驗收**
  - Staff 掃碼後狀態即時變更；後台可查核銷人/時間
  - 活動出席率等統計可用

#### Milestone 4｜分潤歸因（業務 QR）+ 結算報表（1～2 週）
- **範圍**
  - Sales 生成專屬 QR/連結（入口頁）
  - 歸因 token（last touch、有效期 7 天）
  - 分潤成立：以「服務完成」事件作為成立時點
  - 分潤規則：依品項不同規則
  - 分潤流水與回沖（退款/取消自動回沖）
- **驗收**
  - 可從任一成交回推：是哪個 sales 來源、依何規則歸因
  - 可輸出結算報表（期間、狀態、金額）

#### Milestone 5｜電商（首日上線關鍵路徑）（3～6 週，視深度而定）
- **範圍**
  - 商品/SKU/庫存/會員價、購物車、結帳、付款（綠界）、訂單狀態
  - 點數折抵與回補（退款/取消），與點數流水一致
  - 出貨流程與狀態機（首日：完成「下單出貨」閉環）
  -（可後續）電子發票/物流：預留介面，待申請完成後快速補上線
- **驗收**
  - 下單到付款到出貨的狀態機完整；異常（未付款/取消/退款）可回復一致狀態
  - 可對帳：付款事件、訂單狀態、點數扣補、分潤回沖一致

#### Milestone 6（可選）｜廣告位模組（2～4 週）
- **範圍**
  - 方案/檔期/素材審核/排程/刊登報表
  - 與會員等級折扣/免費權益連動
  - 流程：先審核通過再付款
  - 同版位輪播 + 名額限制
- **驗收**
  - 檔期排程可視覺化/可查；刊登紀錄可稽核

---

### 9) 首日上線「最小可營運（MVO）」建議組合

> 若要「同一時間一次上線可用」且風險可控，建議首日至少包含：

- **必上**：M1、M2、M3（LINE+Email 登入/會員卡/點數/活動）、M4（分潤入口）、M5（電商）、B1、B2、B3、B4、B6、B7、B8
- **可延後**：廣告位（B5 / Milestone 6）
- **可後續快速補上**：電子發票/物流（待申請完成）

---

### 10) 驗收標準（以「可營運」為導向）

- **可用性**
  - 會員可登入、可出示會員 QR、可看等級/點數/活動
  - Staff 現場可掃碼核銷（活動/兌換/權益）
  - Admin 後台可建活動、調整點數、查流水、發推播
- **可稽核**
  - 點數與分潤皆有流水，且可匯出
  - 核銷紀錄完整（誰、何時、在哪個活動/兌換）
- **可成長**
  - 會員分群/標籤可用，推播可迭代
  - 分潤歸因規則可配置（至少有效期 + first/last touch）

---

### 11) 風險與依賴（提前拆雷）

- **LINE 相關**
  - LINE Login / Messaging API 申請與審核時間不確定；需提早處理 OA 設定與權限
- **金流**
  - 綠界申請、測試環境與對帳流程需提早開通；退款回沖（點數/分潤）規則要先定
- **電子發票/物流**
  - 申請與測試可能影響時程；建議首日先把接口預留，待申請完成後快速補上線
- **QR 安全**
  - 不可用「固定 QR」做核銷；必須一次性 token + 有效期 + 防重放
- **資料一致性**
  - 點數折抵/退款、分潤回沖是常見坑；一定要用流水設計避免補救困難

---

### 12) 下一步（建議開工節奏）

- 第 5 章決策已更新為目前定案版本（包含：**會員必填欄位**與**帳號合併/綁定規則：允許合併、用戶自行綁定**）。
- 下一份文件建議產出（可直接進入開發）：
  - PRD（需求凍結版）、流程圖（含狀態機：訂單/付款/出貨/點數/核銷/分潤）、資料庫 ERD、API 規格、測試案例清單

---

### 13) 實作進度追蹤（實時更新）

| 項目 | 狀態 | 說明 | 驗收連結/路徑 |
| :--- | :--- | :--- | :--- |
| **Milestone 0: 啟動與架構** | ✅ 已完成 | pnpm monorepo, NestJS, Next.js, SQLite 基礎架構。 | (Root) |
| **Milestone 5: 電商主線 (Guest)** | ✅ 待驗收 | 購物車、結帳、綠界金流(信用卡/ATM)、訂單查詢、Admin 訂單管理。 | `/products`, `/admin/orders` |
| **M1: 品牌官網內容（不需串接）** | ✅ 待驗收 | 新增品牌/服務/型錄/Link Hub 內容頁，並更新導覽與首頁資訊架構。 | `/about`, `/services`, `/catalog`, `/link-hub`, `/` |
| **M2: 會員中心（不需串接）** | ✅ 待驗收 | Email OTP 登入（開發模式）＋會員中心看板（等級/點數/升級進度/活動紀錄）。 | `/login`, `/me` |
| **M3: 活動報名與核銷（不需串接）** | ✅ 待驗收 | 後台活動管理 UI（建立活動/名單/核銷）+ API。 | `/admin/events`, `/admin/events/[id]` |
| **M4: 分潤歸因（不需串接）** | ✅ 待驗收 | `?sales=CODE` 追蹤 7 天並在下單寫入訂單歸因欄位。 | `/?sales=CODE` → `/checkout` → Admin 訂單詳情 |
| **B1: CRM 會員管理（不需串接）** | ✅ 待驗收 | 後台會員清單、會員詳情、點數流水、手動調整點數（會寫入 ADJUST 流水）。 | `/admin/members`, `/admin/members/[id]` |
| **B7: 分潤報表（不需串接）** | ✅ 待驗收 | 後台依 `sales_code` 匯總訂單數/金額，支援期間篩選。 | `/admin/sales` |
| **LINE Login / 推播** | 🛑 待串接 | 需等待 API 權限與設定完成。 | - |
| **電子發票 / 物流** | 🛑 待串接 | 需等待綠界相關申請完成。 | - |

#### 13.1 驗收清單（每項完成後等待你驗收）

- **Milestone 5: 電商主線 (Guest)**（✅ 待驗收）
  - **路徑**：`/products` → `/cart` → `/checkout` → `/checkout/pay`（綠界）→ `/checkout/success` / `/checkout/atm`，以及 `/orders/lookup`
  - **後台**：`/admin/login` → `/admin/orders` → 訂單詳情（出貨資訊/狀態推進/複製工具）
- **M1: 品牌官網內容（✅ 待驗收）**
  - **路徑**：`/`、`/about`、`/services`、`/catalog`、`/link-hub`
- **M2: 會員中心（✅ 待驗收）**
  - **路徑**：`/login`（Email OTP 開發模式）→ `/me`
- **M3: 活動報名與核銷（✅ 待驗收）**
  - **後台路徑**：`/admin/events`（建立/列表）→ `/admin/events/[id]`（名單/核銷）
  - **API 驗收**：建立活動 `POST /api/v1/events`（ADMIN）、後台列表 `GET /api/v1/events`（ADMIN）、名單 `GET /api/v1/events/:id/registrations`（ADMIN）、公開列表 `GET /api/v1/events/public`、報名 `POST /api/v1/events/:id/register`、核銷 `POST /api/v1/events/checkin`（ADMIN/STAFF）
- **M4: 分潤歸因（✅ 待驗收）**
  - **路徑**：先進入 `/?sales=CODE` → 完成下單 → 到 `/admin/orders/[orderNumber]` 查看 `業務歸因：CODE`
- **B1: CRM 會員管理（✅ 待驗收）**
  - **路徑**：`/admin/members`（搜尋/列表）→ `/admin/members/[id]`（流水/調點）
- **B7: 分潤報表（✅ 待驗收）**
  - **路徑**：`/admin/sales`（預設近 30 天，可調整起迄日）